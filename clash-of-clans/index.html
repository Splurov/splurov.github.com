<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta property="fb:admins" content="splurov"/>
    <title>Clash of Clans — Troops and Spells Cost Calculator</title>
    <style>@font-face{font-family:'PT Serif';src:url('/fonts/PTF55F_W.woff') format('woff')}@font-face{font-family:'PT Serif Caption';src:url('/fonts/PTZ55F_W.woff') format('woff')}html,body{background:#fefefe;color:#222}body{font-family:'PT Serif',Georgia,serif;font-size:18px;line-height:1.5;margin:0;padding:20px 40px}a{white-space:nowrap}a:link{color:#4100f1;text-decoration:none}a:visited{color:#63008c;text-decoration:none}a:hover,a:active{text-decoration:underline}h1{font-size:28px;font-family:'PT Serif Caption',Georgia,sans-serif;font-weight:normal;margin:0 0 12px}h2{font-size:22px;font-family:'PT Serif Caption',Georgia,sans-serif;font-weight:normal;margin:18px 0 4px}p{margin:0 0 12px}.content{min-width:260px;max-width:520px}.photo{margin:8px 0 20px 20px;float:right;border-radius:10px}@media all and (max-width:560px){.photo{float:none;display:block;margin:0 auto 20px}}a.fn.url{color:#222;text-decoration:none}.footer{margin-top:30px;font-size:14px;color:#ccc}.footer a:link{text-decoration:underline;color:#ccc}.footer a:visited{text-decoration:underline;color:#ccc}.footer a:hover,.footer a:active{text-decoration:none}.hidden{display:none}</style>
    <style>input,select{font-family:'PT Serif',Georgia,serif;font-size:inherit}.units{border-spacing:0;margin-bottom:24px}.units th{text-align:left;padding:2px 24px 3px 0;font-weight:normal;font-size:22px}.units td{padding:2px 24px 3px 0}.units td>input{text-align:right}.units tfoot td,.units tfoot th{text-align:right}.units-quantity{font-size:16px}.changelog{border-spacing:0;margin-bottom:12px;font-size:14px}.changelog td{padding:2px 24px 3px 0;vertical-align:top}.todo{font-size:14px}.cost-elixir{background:url(/clash-of-clans/i/elixir.png) no-repeat 100% 50%;padding-right:28px}.cost-gold{background:url(/clash-of-clans/i/gold.png) no-repeat 100% 50%;padding-right:28px}.number-plus,.number-minus{color:#000;cursor:pointer;display:inline-block;margin-left:6px;border:1px solid #aaa;border-radius:8px;padding:0 6px}.number{text-align:right}.limit-exceeded{color:#d00}</style>
    <script>navigator.appName=="Microsoft Internet Explorer"&&(function(b,e,c,a){b.src="/clash-of-clans/i/favicon.ico";c=e.getElementsByTagName("script")[0];a=c.parentNode.insertBefore(e.createElement("link"),c);a.rel="shortcut icon";a.href=b.src})(new Image,document);</script>
    <link rel="icon" href="/clash-of-clans/i/favicon.png"/>
    <script type="text/javascript">

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-37991363-1']);
_gaq.push(['_trackPageview']);

(function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

</script>
</head>
<body>

<h1>Clash of Clans — Troops and Spells Cost Calculator</h1>

<p>All entered data will be saved in your browser and pre-filled in next time you visit this page.</p>

<table class="units">
    <tr>
        <td>
            <label for="barracks">Number of Barracks</label>
        </td>
        <td>
            <select id="barracks">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </select>
        </td>
    </tr>

    <tr>
        <td>
            <label for="barracks-level">Maximum Barracks Level</label>
        </td>
        <td>
            <select id="barracks-level">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>
        </td>
    </tr>

    <tr>
        <td>
            <label for="army-camps">Army Camps Capacity</label>
        </td>
        <td>
            <input class="js-number" value="20" id="army-camps" size="4"/>
        </td>
    </tr>

    <tr>
        <td>
            <label for="spell-factory-level">Spell Factory Level</label>
        </td>
        <td>
            <select id="spell-factory-level">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </select>
        </td>
    </tr>
</table>

<table id="units" class="units">
    <thead>
        <tr>
            <th>Unit</th>
            <th>Level</th>
            <th><span class="cost-elixir">Cost</span></th>
            <th>Quantity <span class="units-quantity" title="Free Capacity" id="units-quantity"></span></th>
            <th><span class="cost-elixir">Total Cost</span></th>
        </tr>
    </thead>
    <tbody id="units-body">
    </tbody>
    <tfoot>
        <tr>
            <th colspan="4">All Troops Cost</th>
            <td id="units-cost"></td>
        </tr>
        <tr>
            <th colspan="4">Capacity</th>
            <td id="units-space"></td>
        </tr>
        <tr>
            <th colspan="4">Average Production Time</th>
            <td id="units-time"></td>
        </tr>
    </tfoot>
</table>

<table id="spells" class="units">
    <thead>
        <tr>
            <th>Spell</th>
            <th>Level</th>
            <th><span class="cost-gold">Cost</span></th>
            <th>Quantity <span class="units-quantity" title="Free Capacity" id="spells-quantity"></span></th>
            <th><span class="cost-gold">Total Cost</span></th>
        </tr>
    </thead>
    <tbody id="spells-body">
    </tbody>
    <tfoot>
        <tr>
            <th colspan="4">All Spells Cost</th>
            <td id="spells-cost"></td>
        </tr>
        <tr>
            <th colspan="4">Capacity</th>
            <td id="spells-space"></td>
        </tr>
        <tr>
            <th colspan="4">Production Time</th>
            <td id="spells-time"></td>
        </tr>
    </tfoot>
</table>

<script>(function(){

    'use strict';


    var numberFormat = function(n) {
        return n.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1,');
    };


    var DataStorage = function(key) {
        var data = localStorage.getItem(key);
        if (data) {
            data = JSON.parse(data);
        } else {
            data = {};
        }

        this.get = function(key, defaultValue) {
            var value = data[key];
            if (defaultValue !== undefined && value === undefined) {
                return defaultValue;
            }
            return value;
        };

        this.set = function(key, value) {
            data[key] = value;
        };

        this.update = function() {
            localStorage.setItem(key, JSON.stringify(data));
        };

        return this;
    };


    var savedData = new DataStorage('savedData');


    var barracks = document.getElementById('barracks');
    barracks.options[savedData.get('barracks', barracks.selectedIndex)].selected = true;


    var barracksLevel = document.getElementById('barracks-level');
    barracksLevel.options[savedData.get('barracksLevel', barracksLevel.selectedIndex)].selected = true;


    var armyCamps = document.getElementById('army-camps');
    armyCamps.value = savedData.get('armyCamps', armyCamps.value);


    var spellFactoryLevel = document.getElementById('spell-factory-level');
    spellFactoryLevel.options[savedData.get('spellFactoryLevel', spellFactoryLevel.selectedIndex)].selected = true;


    var units = {
            'Barbarian': [20, [25, 40, 60, 80, 100, 150], 1, 1],
            'Archer': [25, [50, 80, 120, 160, 200, 300], 1, 2],
            'Goblin': [30, [25, 40, 60, 80, 100], 1, 3],
            'Giant': [120, [500, 1000, 1500, 2000, 2500, 3000], 5, 4],
            'Wall_Breaker': [120, [1000, 1500, 2000, 2500, 3000], 1, 5],
            'Balloon': [600, [2000, 2500, 3000, 3500, 4000, 4500], 5, 6],
            'Wizard': [600, [1500, 2000, 2500, 3000, 3500], 4, 7],
            'Healer': [1200, [7000, 10000, 13000], 20, 8],
            'Dragon': [1800, [25000, 32500, 40000], 20, 9],
            'P-E-K-K-A-': [3600, [35000, 42500, 50000], 25, 10]
        },
        unitsTable = document.getElementById('units'),

        spells = {
            'Lightning': [3600, [15000, 16500, 18000, 20000, 22000], 1, 1],
            'Healing': [5400, [20000, 22000, 24000, 26500, 29000], 1, 2],
            'Rage': [7200, [30000, 33000, 36000, 40000, 44000], 1, 3],
            'Jump': [5400, [30000, 38000], 1, 4]
        },
        spellsTable = document.getElementById('spells');


    var calculateItems = function(items, type, params) {
        var levelValue = parseInt(params.levelSelect.value, 10);
        params.table.style.display = (levelValue === 0 ? 'none' : '');

        for (
            var i = parseInt(params.levelSelect.options[params.levelSelect.options.length - 1].value);
            i >= 1;
            i--
        ) {
            document.getElementById(type + '-building-level-' + i).style.display = (i > levelValue ? 'none' : '');
        }

        var totalCost = 0,
            totalSpace = 0,
            totalTime = 0,
            name;
        for (name in items) {
            if (items.hasOwnProperty(name) && items[name][3] <= levelValue) {
                var item = document.getElementById(name);

                var value = parseInt(item.value, 10);

                var levelId = name + '-level',
                    levelEl = document.getElementById(levelId),
                    costEl = document.getElementById(name + '-cost'),
                    summaryEl = document.getElementById(name + '-summary'),
                    costPerItem = levelEl.value,
                    summaryCost = (costPerItem * value);

                costEl.innerHTML = numberFormat(costPerItem);
                summaryEl.innerHTML = (summaryCost ? numberFormat(summaryCost) : 0);

                totalCost += summaryCost;

                totalSpace += (items[name][2] * value);
                totalTime += (items[name][0] * value);

                savedData.set(name, value);
                savedData.set(levelId, levelEl.selectedIndex);
            }
        }

        document.getElementById(type + '-cost').innerHTML = numberFormat(totalCost);

        var spaceDiff = params.space - totalSpace;
        if (spaceDiff < 0) {
            spaceDiff = '<span class="limit-exceeded">' + spaceDiff + '</span>';
        }
        document.getElementById(type + '-quantity').innerHTML = '(' + spaceDiff + ')';

        if (totalSpace > params.space) {
            totalSpace = '<span class="limit-exceeded">' + totalSpace + '</span>';
        }
        totalSpace = totalSpace + ' / ' + params.space;
        document.getElementById(type + '-space').innerHTML = totalSpace;

        var time = Math.ceil(totalTime / params.buildings),
            formattedTime = '';
        if (time > 3599) {
            formattedTime += Math.floor(time / 3600) + 'h ';
            time = time % 3600;
        }
        if (time > 59) {
            formattedTime += Math.floor(time / 60) + 'm ';
            time = time % 60;
        }
        formattedTime += time + 's';
        document.getElementById(type + '-time').innerHTML = formattedTime;
    };


    var calculate = function() {
        calculateItems(units, 'units', {
            'table': unitsTable,
            'levelSelect': barracksLevel,
            'space': armyCamps.value,
            'buildings': barracks.value
        });
        calculateItems(spells, 'spells', {
            'table': spellsTable,
            'levelSelect': spellFactoryLevel,
            'space': spellFactoryLevel.value,
            'buildings': 1
        });

        savedData.set('barracks', barracks.selectedIndex);
        savedData.set('barracksLevel', barracksLevel.selectedIndex);
        savedData.set('armyCamps', armyCamps.value);
        savedData.set('spellFactoryLevel', spellFactoryLevel.selectedIndex);

        savedData.update();
    };


    barracks.addEventListener('change', calculate, false);
    barracksLevel.addEventListener('change', calculate, false);
    armyCamps.addEventListener('input', calculate, false);
    spellFactoryLevel.addEventListener('change', calculate, false);


    var setSpinner = function(el) {

        var plus = function() {
            var current = parseInt(el.value, 10);
            if (isNaN(current)) {
                el.value = 1;
            } else {
                el.value = current + 1;
            }
            calculate();
        };

        var minus = function(){
            var current = parseInt(el.value, 10);
            if (isNaN(current) || current < 2) {
                el.value = 0;
            } else {
                el.value = current - 1;
            }
            calculate();
        };

        var create = function(type){
            var span = document.createElement('span');
            span.className = 'number-' + type;
            span.innerHTML = (type === 'plus' ? '+' : '−');

            span.onclick = (type === 'plus' ? plus : minus);

            var interval = null,
                timeout = null;
            span.onmousedown = function(){
                timeout = window.setTimeout(function(){
                    interval = window.setInterval((type === 'plus' ? plus : minus), 100);
                }, 500);
            };
            span.onmouseup = function(){
                clearTimeout(timeout);
                clearInterval(interval);
            };
            el.parentNode.appendChild(span);
        };

        create('plus');
        create('minus');

    };

    var createRows = function(items, type) {
        for (var name in items) {
            if (items.hasOwnProperty(name)) {
                var item = items[name],
                    itemRow = document.createElement('tr');

                itemRow.setAttribute('id', type + '-building-level-' + item[3]);

                var td1 = document.createElement('td');
                td1.innerHTML = '<label for="' + name + '">' + name.replace('_', ' ').replace(/-/g, '.') + '</label>';
                itemRow.appendChild(td1);

                var levelId = name + '-level',
                    levelIndex = savedData.get(levelId, 0),
                    costPerItem,
                    itemLevelSelect = [];
                itemLevelSelect.push('<select id="' + levelId + '">');
                for (var i = 0, levelLength = item[1].length; i < levelLength; i++) {
                    var levelSelected = '';
                    if (i === levelIndex) {
                        levelSelected = ' selected="selected"';
                        costPerItem = item[1][i];
                    }
                    itemLevelSelect.push('<option value="' + item[1][i] + '"' + levelSelected + '>' + (i + 1) + '</option>');
                }
                itemLevelSelect.push('</select>');

                var td2 = document.createElement('td');
                td2.innerHTML = itemLevelSelect.join('');
                td2.firstChild.addEventListener('change', calculate, false);
                itemRow.appendChild(td2);

                var td3 = document.createElement('td'),
                    costId = name + '-cost';
                td3.setAttribute('id', costId);
                td3.className = 'number';
                td3.innerHTML = costPerItem;
                itemRow.appendChild(td3);

                var defaultValue = savedData.get(name, 0),
                    td4 = document.createElement('td');
                if (type === 'spells') {
                    var itemQuantitySelect = [];
                    itemQuantitySelect.push('<select id="' + name + '">');
                    for (var i = 0; i < 5; i++) {
                        itemQuantitySelect.push('<option value="' + i + '"' + (i === defaultValue ? ' selected="selected"' : '') + '>' + i + '</option>');
                    }
                    itemQuantitySelect.push('</select>');
                    td4.innerHTML = itemQuantitySelect.join('');
                } else {
                    td4.innerHTML = '<input class="js-number" id="' + name + '" size="4" value="' + defaultValue + '"/>';
                }
                td4.firstChild.addEventListener((type === 'spells' ? 'change' : 'input'), calculate, false);
                itemRow.appendChild(td4);

                var summaryId = name + '-summary',
                    td5 = document.createElement('td');
                td5.setAttribute('id', summaryId);
                td5.className = 'number';
                td5.innerHTML = (defaultValue ? numberFormat(costPerItem * defaultValue) : 0);
                itemRow.appendChild(td5);

                document.getElementById(type + '-body').appendChild(itemRow);
            }
        }
    };

    createRows(units, 'units');
    createRows(spells, 'spells');

    var numbers = document.querySelectorAll('.js-number');
    for (var i = 0, numberLength = numbers.length; i < numberLength; i++) {
        setSpinner(numbers[i]);
    }

    calculate();

})();
</script>

<!-- Yandex.Metrika counter -->
<script>(function(g,a,i){(a[i]=a[i]||[]).push(function(){try{a.yaCounter19642528=new Ya.Metrika({id:19642528,webvisor:true,clickmap:true,trackLinks:true,accurateTrackBounce:true})}catch(c){}});var h=g.getElementsByTagName("script")[0],b=g.createElement("script"),e=function(){h.parentNode.insertBefore(b,h)};b.type="text/javascript";b.async=true;b.src=(g.location.protocol=="https:"?"https:":"http:")+"//mc.yandex.ru/metrika/watch.js";if(a.opera=="[object Opera]"){g.addEventListener("DOMContentLoaded",e,false)}else{e()}})(document,window,"yandex_metrika_callbacks");</script>
<noscript><div><img src="//mc.yandex.ru/watch/19642528" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<div id="fb-root"></div>
<script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<h2>Comments</h2>
<p>Feel free to post bugs and feature suggestions.</p>

<div class="fb-comments" data-href="http://mkln.ru/clash-of-clans/" data-width="470" data-num-posts="5"></div>

<h2>Changelog</h2>
<table class="changelog">
    <tr>
        <td>1.3</td>
        <td>8 February, 2013</td>
        <td>
            The title is replaced by the more similar to the contents of the page;<br/>
            Added description for auto-save feature;<br/>
            Added army camps capacity — allows to show free capacity;<br/>
            Added maximum barracks level — allows show/hide unavailable units;<br/>
            Added spells calculation.<br/>
        </td>
    </tr>
    <tr>
        <td>1.2</td>
        <td>6 February, 2013</td>
        <td>
            Added plus/minus buttons;<br/>
            Fixed IE 9+ support;<br/>
            Changed favicon to app store game icon;<br/>
            Added elixir icon to costs;<br/>
            Added intermediate results of the calculations to the units table.<br/>
        </td>
    </tr>
    <tr>
        <td>1.1</td>
        <td>5 February, 2013</td>
        <td>
            Added sixth level for Barbarian, Archer, Giant and Balloon;<br/>
            Fixed Healer 1st level cost;<br/>
            Number of barracks field replaced by the select.<br/>
        </td>
    </tr>
    <tr>
        <td>1.0</td>
        <td>4 February, 2013</td>
        <td>Initial release.</td>
    </tr>
</table>

<h2>To-do</h2>
<div class="todo">
    <p>Distribution of troops between barracks for optimal training speed.</p>
    <p>(?) Save results to simplify comparison of different sets.</p>
    <p>(?) Gem costs.</p>
</div>

<div class="footer">
    Developed by <a href="/en/">Mikhail Kalashnik</a>
</div>

</body>
</html>
